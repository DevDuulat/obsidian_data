  

function custom_register_form() {

ob_start();

if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['custom_register'])) {

$full_name = sanitize_text_field($_POST['full_name']);

$phone = sanitize_text_field($_POST['phone']);

$role = sanitize_text_field($_POST['role']);

$email = sanitize_email($_POST['email']);

$password = $_POST['password'];

  

$errors = [];

  

if (!is_email($email)) {

$errors[] = 'Некорректный email.';

}

  

if (email_exists($email)) {

$errors[] = 'Email уже зарегистрирован.';

}

  

if (empty($password) || strlen($password) < 6) {

$errors[] = 'Пароль должен быть не менее 6 символов.';

}

  

if (empty($errors)) {

// Разбиваем ФИО (если возможно)

$name_parts = explode(' ', $full_name, 2);

$first_name = $name_parts[0] ?? '';

$last_name = $name_parts[1] ?? '';

  

$user_id = wp_insert_user([

'user_login' => $email,

'user_pass' => $password,

'user_email' => $email,

'first_name' => $first_name,

'last_name' => $last_name,

'role' => $role,

]);

  

if (!is_wp_error($user_id)) {

update_user_meta($user_id, 'phone', $phone);

  

// Отправка email

$subject = 'Добро пожаловать на сайт';

$message = "Здравствуйте, $full_name!\n\nВы успешно зарегистрированы.\n\nВаш логин: $email\nВаш пароль: $password\n\nСпасибо за регистрацию!";

$headers = ['Content-Type: text/plain; charset=UTF-8'];

  

wp_mail($email, $subject, $message, $headers);

  

echo '<p>Регистрация прошла успешно! Проверьте ваш email.</p>';

} else {

echo '<p>Ошибка: ' . $user_id->get_error_message() . '</p>';

}

} else {

foreach ($errors as $error) {

echo '<p style="color:red;">' . $error . '</p>';

}

}

}

?>

  

<form method="post">

<p><input type="text" name="full_name" placeholder="ФИО" required></p>

<p><input type="text" name="phone" placeholder="Телефон" required></p>

<p><input type="email" name="email" placeholder="Email" required></p>

<p><input type="password" name="password" placeholder="Пароль" required></p>

  

<p>

<select name="role" required>

<option value="">Выберите роль</option>

<option value="subscriber">Пользователь</option>

<option value="editor">Редактор</option>

<option value="author">Автор</option>

</select>

</p>

  

<p><button type="submit" name="custom_register">Зарегистрироваться</button></p>

</form>

  

<?php

return ob_get_clean();

}

  

add_shortcode('custom_register_form', 'custom_register_form');

  

function custom_login_form() {

ob_start();

  

// Проверка: если пользователь уже вошел

if (is_user_logged_in()) {

echo '<p>Вы уже вошли. <a href="' . wp_logout_url(home_url()) . '">Выйти?</a></p>';

return ob_get_clean();

}

  

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['custom_login'])) {

$email = sanitize_email($_POST['email']);

$password = $_POST['password'];

  

$user = get_user_by('email', $email);

if ($user) {

$creds = [

'user_login' => $user->user_login,

'user_password' => $password,

'remember' => true,

];

  

$signon = wp_signon($creds, false);

  

if (is_wp_error($signon)) {

echo '<p style="color:red;">Неверный email или пароль.</p>';

} else {

wp_set_current_user($signon->ID);

wp_set_auth_cookie($signon->ID, true);

echo '<p style="color:green;">Успешный вход. Перенаправление...</p>';

echo '<script>setTimeout(function(){ window.location.href = "' . home_url() . '"; }, 2000);</script>';

}

} else {

echo '<p style="color:red;">Пользователь с таким email не найден.</p>';

}

}

  

?>

<form method="post">

<p><input type="email" name="email" placeholder="Email" required></p>

<p><input type="password" name="password" placeholder="Пароль" required></p>

<p><button type="submit" name="custom_login">Войти</button></p>

</form>

<?php

  

return ob_get_clean();

}

  

add_shortcode('custom_login_form', 'custom_login_form');

  
  
  

function custom_password_reset_form() {

ob_start();

  

if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['custom_password_reset'])) {

$email = sanitize_email($_POST['email']);

  

if (!is_email($email)) {

echo '<p style="color:red;">Введите корректный email.</p>';

} elseif (!email_exists($email)) {

echo '<p style="color:red;">Пользователь с таким email не найден.</p>';

} else {

$user = get_user_by('email', $email);

$reset_key = get_password_reset_key($user);

  

if (is_wp_error($reset_key)) {

echo '<p style="color:red;">Ошибка при создании ссылки для сброса.</p>';

} else {

$reset_url = site_url("wp-login.php?action=rp&key=$reset_key&login=" . rawurlencode($user->user_login), 'login');

  

// Отправка письма

$subject = 'Сброс пароля';

$message = "Здравствуйте, вы запросили сброс пароля.\n\nСсылка для сброса: $reset_url";

wp_mail($email, $subject, $message);

  

echo '<p style="color:green;">Письмо со ссылкой отправлено на почту.</p>';

}

}

}

  

?>

<form method="post">

<p><input type="email" name="email" placeholder="Введите ваш email" required></p>

<p><button type="submit" name="custom_password_reset">Сбросить пароль</button></p>

</form>

<?php

  

return ob_get_clean();

}

  

add_shortcode('custom_password_reset_form', 'custom_password_reset_form');